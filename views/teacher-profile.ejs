<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Teacher Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Profile specific styles */
        .profile-container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .profile-sidebar {
            flex: 1;
            min-width: 280px;
            max-width: 320px;
        }
        
        .profile-main {
            flex: 2;
            min-width: 600px;
        }
        
        .profile-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .profile-header {
            padding: 30px;
            text-align: center;
            position: relative;
            background-color: #4CAF50;
            color: white;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
        }
        
        .profile-name {
            font-size: 22px;
            font-weight: bold;
            margin: 0 0 5px;
        }
        
        .profile-role {
            font-size: 14px;
            opacity: 0.8;
            margin: 0;
        }
        
        .profile-stats {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #777;
        }
        
        .profile-info {
            padding: 20px;
        }
        
        .info-item {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .info-item i {
            font-size: 18px;
            color: #4CAF50;
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .info-label {
            font-size: 14px;
            color: #666;
            margin-right: 10px;
            width: 80px;
        }
        
        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .edit-btn {
            background-color: #e3f2fd;
            color: #1565c0;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn:hover {
            background-color: #bbdefb;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.25);
        }
        
        .invalid-feedback {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .form-control.is-invalid {
            border-color: #f44336;
        }
        
        .form-control.is-invalid + .invalid-feedback {
            display: block;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        
        .btn-cancel {
            background-color: #f5f5f5;
            color: #333;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-save {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-save:hover {
            background-color: #45a049;
        }
        
        .btn-cancel:hover {
            background-color: #e0e0e0;
        }
        
        .security-section {
            margin-top: 30px;
        }
        
        .password-form {
            display: none;
        }
        
        .password-form.active {
            display: block;
        }
        
        .password-strength {
            height: 5px;
            background-color: #eee;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .password-strength-value {
            height: 100%;
            width: 0;
            transition: width 0.3s;
        }
        
        .strength-weak {
            background-color: #f44336;
        }
        
        .strength-medium {
            background-color: #ff9800;
        }
        
        .strength-strong {
            background-color: #4caf50;
        }
        
        .strength-text {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
        }
        
        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }
        
        .avatar-input {
            display: none;
        }
        
        .avatar-label {
            display: inline-block;
            padding: 8px 12px;
            background-color: #e3f2fd;
            color: #1565c0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .avatar-label:hover {
            background-color: #bbdefb;
        }
    </style>
</head>
<body>
    <!-- Left Sidebar -->
    <div class="sidebar">
        <h2><i class="fas fa-chalkboard-teacher"></i> Teacher Portal</h2>
        <ul>
            <li><a href="/teacher/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="/teacher/classes"><i class="fas fa-users"></i> My Classes</a></li>
            <li><a href="/teacher/attendance"><i class="fas fa-clipboard-check"></i> Attendance</a></li>
            <li><a href="/teacher/quizzes"><i class="fas fa-question-circle"></i> Quizzes & Grades</a></li>
            <li><a href="/teacher/profile" class="active"><i class="fas fa-user"></i> My Profile</a></li>
            <li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="title">
                <h1><i class="fas fa-user"></i> My Profile</h1>
                <p>View and manage your account details</p>
            </div>
            <div class="user-info">
                <span><%= teacher.firstName %> <%= teacher.lastName %></span>
                <img src="<%= teacher.profilePicture || '/img/default-avatar.png' %>" alt="Profile Picture">
            </div>
        </div>

        <div class="content">
            <div class="profile-container">
                <div class="profile-sidebar">
                    <div class="profile-card">
                        <div class="profile-header">
                            <img src="<%= teacher.profilePicture || '/img/default-avatar.png' %>" alt="<%= teacher.firstName %>" class="profile-avatar">
                            <h2 class="profile-name"><%= teacher.firstName %> <%= teacher.lastName %></h2>
                            <p class="profile-role">Teacher</p>
                        </div>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value"><%= stats.classesCount || 0 %></div>
                                <div class="stat-label">Classes</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value"><%= stats.studentsCount || 0 %></div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value"><%= stats.quizzesCount || 0 %></div>
                                <div class="stat-label">Quizzes</div>
                            </div>
                        </div>
                        <div class="profile-info">
                            <div class="info-item">
                                <i class="fas fa-envelope"></i>
                                <div class="info-label">Email:</div>
                                <div class="info-value"><%= teacher.email %></div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-user"></i>
                                <div class="info-label">Username:</div>
                                <div class="info-value"><%= teacher.username %></div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-phone"></i>
                                <div class="info-label">Phone:</div>
                                <div class="info-value"><%= teacher.phoneNumber || 'Not set' %></div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar-alt"></i>
                                <div class="info-label">Joined:</div>
                                <div class="info-value"><%= new Date(teacher.createdAt).toLocaleDateString() %></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-main">
                    <div class="profile-card">
                        <div class="profile-info">
                            <div class="section-header">
                                <h3 class="section-title">Personal Information</h3>
                                <button type="button" class="edit-btn" id="edit-profile-btn">
                                    <i class="fas fa-edit"></i> Edit Profile
                                </button>
                            </div>

                            <div id="profile-view">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>First Name</label>
                                        <div id="display-first-name" class="form-display"><%= teacher.firstName %></div>
                                    </div>
                                    <div class="form-group">
                                        <label>Last Name</label>
                                        <div id="display-last-name" class="form-display"><%= teacher.lastName %></div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Email Address</label>
                                        <div id="display-email" class="form-display"><%= teacher.email %></div>
                                    </div>
                                    <div class="form-group">
                                        <label>Phone Number</label>
                                        <div id="display-phone" class="form-display"><%= teacher.phoneNumber || 'Not set' %></div>
                                    </div>
                                </div>
                            </div>

                            <div id="profile-form" style="display: none;">
                                <form id="edit-profile-form">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="first-name">First Name</label>
                                            <input type="text" id="first-name" class="form-control" value="<%= teacher.firstName %>" required>
                                            <div class="invalid-feedback">First name is required</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="last-name">Last Name</label>
                                            <input type="text" id="last-name" class="form-control" value="<%= teacher.lastName %>" required>
                                            <div class="invalid-feedback">Last name is required</div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="email">Email Address</label>
                                            <input type="email" id="email" class="form-control" value="<%= teacher.email %>" required>
                                            <div class="invalid-feedback">Valid email is required</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="phone">Phone Number</label>
                                            <input type="tel" id="phone" class="form-control" value="<%= teacher.phoneNumber || '' %>" placeholder="Enter phone number">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-picture">Profile Picture</label>
                                        <div style="text-align: center; margin-bottom: 10px;">
                                            <img id="avatar-preview" src="<%= teacher.profilePicture || '/img/default-avatar.png' %>" class="avatar-preview">
                                            <br>
                                            <input type="file" id="profile-picture" class="avatar-input" accept="image/*">
                                            <label for="profile-picture" class="avatar-label">Choose Image</label>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn-cancel" id="cancel-profile-edit">Cancel</button>
                                        <button type="submit" class="btn-save">Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="profile-card security-section">
                        <div class="profile-info">
                            <div class="section-header">
                                <h3 class="section-title">Security</h3>
                                <button type="button" class="edit-btn" id="change-password-btn">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>

                            <div id="password-form" class="password-form">
                                <form id="change-password-form">
                                    <div class="form-group">
                                        <label for="current-password">Current Password</label>
                                        <input type="password" id="current-password" class="form-control" required>
                                        <div class="invalid-feedback">Current password is required</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="new-password">New Password</label>
                                        <input type="password" id="new-password" class="form-control" required>
                                        <div class="password-strength">
                                            <div id="password-strength-value" class="password-strength-value"></div>
                                        </div>
                                        <div id="password-strength-text" class="strength-text"></div>
                                        <div class="invalid-feedback">Password must be at least 8 characters</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirm-password">Confirm New Password</label>
                                        <input type="password" id="confirm-password" class="form-control" required>
                                        <div class="invalid-feedback">Passwords do not match</div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="button" class="btn-cancel" id="cancel-password-change">Cancel</button>
                                        <button type="submit" class="btn-save">Update Password</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Logout functionality
        document.getElementById('logout-link').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                const response = await fetch('/teacher/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/teacher/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Edit profile button
        document.getElementById('edit-profile-btn').addEventListener('click', function() {
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('profile-form').style.display = 'block';
        });

        // Cancel profile edit button
        document.getElementById('cancel-profile-edit').addEventListener('click', function() {
            document.getElementById('profile-form').style.display = 'none';
            document.getElementById('profile-view').style.display = 'block';
        });

        // Change password button
        document.getElementById('change-password-btn').addEventListener('click', function() {
            document.getElementById('password-form').classList.toggle('active');
            this.innerHTML = document.getElementById('password-form').classList.contains('active') 
                ? '<i class="fas fa-times"></i> Cancel'
                : '<i class="fas fa-key"></i> Change Password';
        });

        // Cancel password change
        document.getElementById('cancel-password-change').addEventListener('click', function() {
            document.getElementById('password-form').classList.remove('active');
            document.getElementById('change-password-btn').innerHTML = '<i class="fas fa-key"></i> Change Password';
            document.getElementById('change-password-form').reset();
        });

        // Profile picture preview
        document.getElementById('profile-picture').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatar-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Password strength meter
        document.getElementById('new-password').addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 8) strength += 25;
            if (password.match(/[a-z]+/)) strength += 25;
            if (password.match(/[A-Z]+/)) strength += 25;
            if (password.match(/[0-9]+/)) strength += 25;
            
            const strengthBar = document.getElementById('password-strength-value');
            const strengthText = document.getElementById('password-strength-text');
            
            strengthBar.style.width = strength + '%';
            
            // Remove all classes
            strengthBar.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
            
            if (strength <= 50) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'Weak';
                strengthText.style.color = '#f44336';
            } else if (strength <= 75) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = 'Medium';
                strengthText.style.color = '#ff9800';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'Strong';
                strengthText.style.color = '#4caf50';
            }
        });

        // Password confirmation validation
        document.getElementById('confirm-password').addEventListener('input', function() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = this.value;
            
            if (newPassword !== confirmPassword) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Edit profile form submission
        document.getElementById('edit-profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Basic validation
            let isValid = true;
            const firstName = document.getElementById('first-name');
            const lastName = document.getElementById('last-name');
            const email = document.getElementById('email');
            
            if (!firstName.value.trim()) {
                firstName.classList.add('is-invalid');
                isValid = false;
            } else {
                firstName.classList.remove('is-invalid');
            }
            
            if (!lastName.value.trim()) {
                lastName.classList.add('is-invalid');
                isValid = false;
            } else {
                lastName.classList.remove('is-invalid');
            }
            
            if (!email.value.trim() || !email.value.includes('@')) {
                email.classList.add('is-invalid');
                isValid = false;
            } else {
                email.classList.remove('is-invalid');
            }
            
            if (!isValid) return;
            
            // Prepare form data (if profile picture was changed, would need to handle file upload)
            const formData = {
                firstName: firstName.value,
                lastName: lastName.value,
                email: email.value,
                phoneNumber: document.getElementById('phone').value
            };
            
            try {
                const response = await fetch('/api/teacher/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Profile updated successfully!');
                    // Update display values
                    document.getElementById('display-first-name').textContent = formData.firstName;
                    document.getElementById('display-last-name').textContent = formData.lastName;
                    document.getElementById('display-email').textContent = formData.email;
                    document.getElementById('display-phone').textContent = formData.phoneNumber || 'Not set';
                    
                    // Update header display
                    document.querySelector('.user-info span').textContent = `${formData.firstName} ${formData.lastName}`;
                    
                    // Hide form and show view
                    document.getElementById('profile-form').style.display = 'none';
                    document.getElementById('profile-view').style.display = 'block';
                } else {
                    alert(`Error updating profile: ${data.message}`);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile. Please try again.');
            }
        });

        // Change password form submission
        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Basic validation
            let isValid = true;
            const currentPassword = document.getElementById('current-password');
            const newPassword = document.getElementById('new-password');
            const confirmPassword = document.getElementById('confirm-password');
            
            if (!currentPassword.value) {
                currentPassword.classList.add('is-invalid');
                isValid = false;
            } else {
                currentPassword.classList.remove('is-invalid');
            }
            
            if (!newPassword.value || newPassword.value.length < 8) {
                newPassword.classList.add('is-invalid');
                isValid = false;
            } else {
                newPassword.classList.remove('is-invalid');
            }
            
            if (newPassword.value !== confirmPassword.value) {
                confirmPassword.classList.add('is-invalid');
                isValid = false;
            } else {
                confirmPassword.classList.remove('is-invalid');
            }
            
            if (!isValid) return;
            
            try {
                const response = await fetch('/api/teacher/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword.value,
                        newPassword: newPassword.value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Password updated successfully!');
                    // Reset form and hide
                    this.reset();
                    document.getElementById('password-form').classList.remove('active');
                    document.getElementById('change-password-btn').innerHTML = '<i class="fas fa-key"></i> Change Password';
                } else {
                    alert(`Error updating password: ${data.message}`);
                }
            } catch (error) {
                console.error('Error updating password:', error);
                alert('Failed to update password. Please try again.');
            }
        });
    </script>
</body>
</html> 